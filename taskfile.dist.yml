version: "3"

vars:
  DEFAULT_APP: admin
  APP: "{{.APP | default .DEFAULT_APP}}"

tasks:
  clean:
    desc: "Remove node_modules, .turbo, .next"
    cmds:
      - rm -rf node_modules
      - rm -rf .turbo
      - find . -name "node_modules" -type d -prune -exec rm -rf '{}' +
      - find . -name "dist" -type d -prune -exec rm -rf '{}' +
      - find . -name ".next" -type d -prune -exec rm -rf '{}' +
      - find . -name ".turbo" -type d -prune -exec rm -rf '{}' +
      - pnpm store prune

  install:
    desc: "Install all dependencies"
    cmds:
      - pnpm install

  ci:
    desc: "Install dependencies in CI mode (frozen lockfile)"
    cmds:
      - pnpm install --frozen-lockfile

  dev:
    desc: "Run dev server for selected app (default: admin)"
    cmds:
      - pnpm turbo run dev --filter={{.APP}}

  build:
    desc: "Build the entire repo"
    cmds:
      - pnpm build

  preview:
    desc: "Build + start app in prod mode (default: admin)"
    cmds:
      - pnpm --filter {{.APP}} build
      - pnpm --filter {{.APP}} start

  lint:
    desc: "Run lint with fix across all packages"
    cmds:
      - pnpm lint

  format:
    desc: "Format all files"
    cmds:
      - pnpm format

  check-types:
    desc: "Run type checks across all packages"
    cmds:
      - pnpm check-types

  clean-start:
    desc: "Clean project, install dependencies, start dev server"
    cmds:
      - task: clean
      - task: ci
      - task: dev
